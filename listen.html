<!DOCTYPE html>
<html lang="en" dir="ltr">
<meta name="viewport" content="width=device-width, initial-scale=1">
<head>
  <meta charset="utf-8" />
  <title>Realtime Speech-to-Text (Web Speech API)</title>
  <link href="https://fonts.googleapis.com/css2?family=Lexend:wght@100..800&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <style>
    :root {
      --background-color: #fff;
      --text-color: #000;
      --header-background: #666;
      --header-color: #fff;
      --accent: #4f46e5;
      --danger: #dc2626;
      box-sizing: border-box;
      font-family: "Lexend", "Helvetica Neue", "Helvetica", sans-serif;
      font-size: 18px;
    }
    *, *::before, *::after { box-sizing: inherit; }

    body {
      background-color: var(--background-color);
      color: var(--text-color);
      margin: 0;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }
    header, footer {
      background-color: var(--header-background);
      color: var(--header-color);
      padding: .5rem 1rem;
    }
    header, footer { display: none; } /* keep from the template but hidden */

    main {
      flex: 1 1 auto;
      max-width: 900px;
      width: 100%;
      margin: 0 auto;
      padding: 1rem;
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: .5rem;
      align-items: center;
    }
    button {
      border: none;
      border-radius: .5rem;
      padding: .6rem 1rem;
      font-size: 1rem;
      cursor: pointer;
    }
    button.primary { background: var(--accent); color: #fff; }
    button.danger  { background: var(--danger); color: #fff; }
    button:disabled { opacity: .5; cursor: not-allowed; }

    select, textarea {
      font: inherit;
      border: 1px solid #ccc;
      border-radius: .5rem;
      padding: .4rem .6rem;
    }

    .status {
      display: inline-flex;
      align-items: center;
      gap: .4rem;
      margin-left: auto;
      font-size: .9rem;
    }
    .dot {
      width: .65rem;
      height: .65rem;
      border-radius: 999px;
      background: #999;
      box-shadow: 0 0 0 0 rgba(79,70,229,.7);
      transition: background .2s;
    }
    .dot.live {
      background: #10b981;
      animation: pulse 1.2s infinite;
    }
    @keyframes pulse {
      0%   { box-shadow: 0 0 0 0 rgba(16,185,129,.6); }
      70%  { box-shadow: 0 0 0 10px rgba(16,185,129,0); }
      100% { box-shadow: 0 0 0 0 rgba(16,185,129,0); }
    }

    .transcripts {
      border: 1px solid #e5e7eb;
      border-radius: .5rem;
      padding: 1rem;
      min-height: 200px;
      line-height: 1.5;
      overflow-y: auto;
      background: #fafafa;
    }
    .final {
      white-space: pre-wrap;
    }
    .interim {
      opacity: .5;
    }

    .log {
      font-size: .8rem;
      color: #6b7280;
      max-height: 140px;
      overflow-y: auto;
      border-left: 3px solid #e5e7eb;
      padding-left: .75rem;
    }

    .actions {
      display: flex;
      gap: .5rem;
      justify-content: flex-end;
    }
  </style>
</head>
<body>
  <main>
    <h1>Realtime Speech‑to‑Text</h1>

    <noscript>This demo needs JavaScript enabled.</noscript>

    <div id="unsupported" style="display:none; padding:1rem; border:1px solid #fca5a5; background:#fee2e2; color:#991b1b; border-radius:.5rem;">
      Your browser doesn’t support the Web Speech API (SpeechRecognition / webkitSpeechRecognition).
    </div>

    <div class="controls">
      <button id="startBtn" class="primary"><i class="fa fa-microphone"></i> Start</button>
      <button id="stopBtn" class="danger" disabled><i class="fa fa-stop"></i> Stop</button>

      <label for="lang" style="margin-left:.5rem;">Lang:</label>
      <select id="lang">
        <option value="en-US" selected>English (US)</option>
        <option value="en-GB">English (UK)</option>
        <option value="es-ES">Español (ES)</option>
        <option value="es-MX">Español (MX)</option>
        <option value="fr-FR">Français</option>
        <option value="de-DE">Deutsch</option>
        <option value="ja-JP">日本語</option>
        <option value="zh-CN">中文 (简体)</option>
      </select>

      <label style="display:flex; align-items:center; gap:.35rem; margin-left:.5rem;">
        <input type="checkbox" id="punctuate" checked />
        Smart punctuation
      </label>

      <span class="status">
        <span id="statusDot" class="dot"></span>
        <span id="statusText">idle</span>
      </span>
    </div>

    <div class="transcripts" id="transcripts">
      <div class="final" id="finalText"></div>
      <div class="interim" id="interimText"></div>
    </div>

    <div class="actions">
      <button id="copyBtn" title="Copy transcript to clipboard"><i class="fa-regular fa-copy"></i> Copy</button>
      <button id="downloadBtn" title="Download transcript as .txt"><i class="fa fa-download"></i> Download</button>
      <button id="clearBtn" title="Clear transcript"><i class="fa fa-trash"></i> Clear</button>
    </div>

    <details>
      <summary>Debug log</summary>
      <div id="log" class="log"></div>
    </details>
  </main>

<script>
(function () {
  const $  = s => document.querySelector(s);
  const $$ = s => document.querySelectorAll(s);

  const startBtn   = $('#startBtn');
  const stopBtn    = $('#stopBtn');
  const langSel    = $('#lang');
  const punctuate  = $('#punctuate');
  const finalBox   = $('#finalText');
  const interimBox = $('#interimText');
  const logBox     = $('#log');
  const statusDot  = $('#statusDot');
  const statusText = $('#statusText');
  const copyBtn    = $('#copyBtn');
  const downloadBtn= $('#downloadBtn');
  const clearBtn   = $('#clearBtn');
  const unsupported= $('#unsupported');

  const Recognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  let recognition   = null;

  const state = {
    listening: false,
    finalTranscript: '',
    autoRestart: true,
  };

  if (!Recognition) {
    unsupported.style.display = 'block';
    startBtn.disabled = true;
    return;
  }

  function log(...args) {
    const time = new Date().toLocaleTimeString();
    logBox.textContent += `[${time}] ${args.join(' ')}\n`;
    logBox.scrollTop = logBox.scrollHeight;
  }

  function setStatus(isLive, text) {
    statusDot.classList.toggle('live', !!isLive);
    statusText.textContent = text || (isLive ? 'listening...' : 'idle');
  }

  function ensureRecognition() {
    if (recognition) {
      recognition.abort();
      recognition = null;
    }
    recognition = new Recognition();
    recognition.lang = langSel.value;
    recognition.continuous = true;
    recognition.interimResults = true;

    recognition.onstart = () => {
      state.listening = true;
      startBtn.disabled = true;
      stopBtn.disabled = false;
      setStatus(true, 'listening…');
      log('onstart');
    };

    recognition.onerror = (e) => {
      log('onerror:', e.error);
      setStatus(false, 'error: ' + e.error);
      // If it's "not-allowed" or "service-not-allowed", don't auto-restart.
      if (e.error === 'not-allowed' || e.error === 'service-not-allowed') {
        state.autoRestart = false;
      }
    };

    recognition.onend = () => {
      state.listening = false;
      startBtn.disabled = false;
      stopBtn.disabled = true;
      setStatus(false, 'idle');
      log('onend');
      if (state.autoRestart) {
        log('auto-restarting…');
        start();
      }
    };

    recognition.onresult = (event) => {
      let interim = '';
      for (let i = event.resultIndex; i < event.results.length; ++i) {
        const res = event.results[i][0].transcript;
        if (event.results[i].isFinal) {
          state.finalTranscript += punctuate.checked ? smartPunctuate(res) : res;
        } else {
          interim += punctuate.checked ? smartPunctuate(res) : res;
        }
      }

      interimBox.textContent = interim;
      finalBox.textContent = state.finalTranscript;
      scrollToBottom();
    };
  }

  function scrollToBottom() {
    const transcripts = $('#transcripts');
    transcripts.scrollTop = transcripts.scrollHeight;
  }

  function smartPunctuate(str) {
    // Extremely lightweight heuristics; tweak as you like.
    let s = str;
    // Capitalize first letter of sentences.
    s = s.replace(/(^\s*[a-z])|([.!?]\s+[a-z])/g, m => m.toUpperCase());
    // Ensure spacing after punctuation.
    s = s.replace(/([,.!?])([^\s])/g, '$1 $2');
    return s;
  }

  async function start() {
    if (!Recognition) return;
    state.autoRestart = true;
    ensureRecognition();
    try {
      recognition.start();
    } catch (e) {
      // Safari sometimes throws if called too quickly.
      log('start error:', e.message);
    }
  }

  function stop() {
    state.autoRestart = false;
    if (recognition) {
      recognition.stop();
    }
  }

  function copyToClipboard() {
    const full = (state.finalTranscript + ' ' + interimBox.textContent).trim();
    navigator.clipboard.writeText(full).then(() => {
      log('Copied transcript to clipboard.');
    }).catch(err => log('Clipboard error:', err));
  }

  function download() {
    const full = (state.finalTranscript + ' ' + interimBox.textContent).trim();
    const blob = new Blob([full], { type: 'text/plain;charset=utf-8' });
    const url  = URL.createObjectURL(blob);
    const a    = document.createElement('a');
    a.href = url;
    a.download = `transcript-${new Date().toISOString().replace(/[:.]/g,'-')}.txt`;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }

  function clearTranscript() {
    state.finalTranscript = '';
    finalBox.textContent = '';
    interimBox.textContent = '';
  }

  // === wire up ===
  startBtn.addEventListener('click', start);
  stopBtn.addEventListener('click', stop);
  copyBtn.addEventListener('click', copyToClipboard);
  downloadBtn.addEventListener('click', download);
  clearBtn.addEventListener('click', clearTranscript);

  langSel.addEventListener('change', () => {
    if (state.listening) {
      // switch language live
      stop();
      start();
    }
  });

  window.addEventListener('beforeunload', () => {
    state.autoRestart = false;
    if (recognition) recognition.abort();
  });

})();
</script>
</body>
</html>
